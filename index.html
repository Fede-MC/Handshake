<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Interactiva - UTN</title>
    <style>
        :root { --color-primary: #005A9C; --color-secondary: #0D223F; --color-accent: #FFC107; --color-light: #f4f4f4; --color-dark: #333; --color-correct: #28a745; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--color-light); color: var(--color-dark); display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
        .app-container { width: 100%; max-width: 800px; margin: 1rem; background-color: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .screen { display: none; padding: 2rem; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
        .screen.active { display: flex; }
        h1, h2 { color: var(--color-secondary); margin-bottom: 1rem; }
        p { margin-bottom: 1.5rem; line-height: 1.6; color: #555; }
        input { width: 100%; max-width: 350px; padding: 0.8rem; border: 2px solid #ccc; border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; text-align: center; }
        button { background-color: var(--color-primary); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        /* Estilos específicos del profesor */
        #lobby-header { margin-bottom: 2rem; }
        #lobby-game-code { color: var(--color-primary); font-weight: bold; background-color: #eee; padding: 10px 20px; border-radius: 8px; font-size: 2.5rem; font-family: 'Courier New', Courier, monospace; letter-spacing: 4px; }
        #player-lobby-list { list-style: none; padding: 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 2rem; max-width: 600px; }
        #player-lobby-list li { background: #e0e0e0; padding: 0.5rem 1rem; border-radius: 20px; }
        #results-chart { width: 100%; max-width: 600px; margin-top: 1rem; }
        .bar-container { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .bar-label { width: 25%; text-align: right; padding-right: 10px; font-size: 0.9rem;}
        .bar { height: 30px; background-color: var(--color-primary); color: white; display: flex; align-items: center; justify-content: flex-start; padding-left: 10px; border-radius: 0 5px 5px 0; transition: width 0.5s ease; }
        .bar.correct { background-color: var(--color-correct); }
        #scoreboard { list-style: decimal; width: 100%; max-width: 400px; padding-left: 20px; text-align: left; }
        #scoreboard li { background-color: var(--color-light); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-weight: bold; }
        #scoreboard li:nth-child(1) { background-color: #ffd700; }
        /* Estilos específicos del estudiante */
        #options-container { display: grid; grid-template-columns: 1fr; gap: 1rem; width: 100%; max-width: 400px; }
        .option-btn { width: 100%; padding: 1.2rem; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ===== INTERFAZ DEL PROFESOR (Oculta por defecto) ===== -->
        <div id="profesor-view" style="display: none;">
            <section id="init-screen-prof" class="screen">
                <h1>Panel del Profesor</h1>
                <p>Crea una nueva sala de juego para empezar.</p>
                <button id="create-game-btn">Crear Juego</button>
            </section>
            <section id="lobby-screen-prof" class="screen">
                <div id="lobby-header">
                    <h2>Sala de Espera</h2>
                    <p>Comparte este código con tus estudiantes:</p>
                    <p><span id="lobby-game-code"></span></p>
                </div>
                <h3>Jugadores Conectados:</h3>
                <ul id="player-lobby-list"></ul>
                <button id="start-game-btn" disabled>Empezar Juego (mín. 1 jugador)</button>
            </section>
            <section id="game-screen-prof" class="screen">
                <h2 id="question-text-prof"></h2>
                <p>Respuestas: <span id="response-count">0</span> / <span id="total-players">0</span></p>
                <div id="results-chart"></div>
                <button id="next-question-btn" style="display: none;">Siguiente Pregunta</button>
                <button id="show-ranking-btn" style="display: none;">Ver Ranking Final</button>
            </section>
            <section id="ranking-screen-prof" class="screen">
                <h2>Ranking Final</h2>
                <ol id="scoreboard"></ol>
                <button onclick="window.location.href=window.location.pathname + '?teach'">Crear Nuevo Juego</button>
            </section>
        </div>

        <!-- ===== INTERFAZ DEL ESTUDIANTE (Oculta por defecto) ===== -->
        <div id="estudiante-view" style="display: none;">
            <section id="join-screen-stud" class="screen">
                <h1>Unirse al Juego</h1>
                <input type="text" id="player-name" placeholder="Tu Nombre" required>
                <input type="text" id="game-code-input" placeholder="Código de la Sala" required>
                <button id="join-btn">Unirse</button>
            </section>
            <section id="waiting-screen-stud" class="screen">
                <h2>¡Conectado!</h2>
                <p>Esperando que el profesor inicie el juego...</p>
            </section>
            <section id="question-screen-stud" class="screen">
                <div id="options-container"></div>
            </section>
            <section id="answer-sent-screen-stud" class="screen">
                <h2>Respuesta enviada</h2>
                <p>Esperando los resultados...</p>
            </section>
            <section id="end-screen-stud" class="screen">
                <h2>¡Juego terminado!</h2>
                <p>El profesor mostrará el ranking final.</p>
            </section>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBG_fLl8uTo3ra3nLvB28KX39Tm6ygjmOo",
            authDomain: "juego-trivia-utn-clase-12.firebaseapp.com",
            projectId: "juego-trivia-utn-clase-12",
            storageBucket: "juego-trivia-utn-clase-12.appspot.com",
            messagingSenderId: "773704295120",
            appId: "1:773704295120:web:52003bc5f325e2ca9434d5",
            measurementId: "G-HY3V2T781F"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('teach')) {
                document.getElementById('profesor-view').style.display = 'block';
                initProfesor();
            } else {
                document.getElementById('estudiante-view').style.display = 'block';
                initEstudiante();
            }
        });

        // =====================================================================
        // ======================= CÓDIGO DEL PROFESOR =========================
        // =====================================================================
        function initProfesor() {
            const screens = { init: document.getElementById('init-screen-prof'), lobby: document.getElementById('lobby-screen-prof'), game: document.getElementById('game-screen-prof'), ranking: document.getElementById('ranking-screen-prof') };
            const createGameBtn = document.getElementById('create-game-btn');
            const lobbyGameCodeEl = document.getElementById('lobby-game-code');
            const playerLobbyList = document.getElementById('player-lobby-list');
            const startGameBtn = document.getElementById('start-game-btn');
            const questionTextProf = document.getElementById('question-text-prof');
            const responseCountEl = document.getElementById('response-count');
            const totalPlayersEl = document.getElementById('total-players');
            const resultsChart = document.getElementById('results-chart');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const showRankingBtn = document.getElementById('show-ranking-btn');
            const scoreboard = document.getElementById('scoreboard');

            let gameCode = null, currentQuestionIndex = -1, playersUnsubscribe = null, responsesUnsubscribe = null, totalPlayers = 0;

            const questions = [
                { category: 'Virtualización', text: '¿Cuál es el propósito principal de la virtualización?', options: ['Hacer una PC más grande', 'Ejecutar múltiples SO en un hardware', 'Aumentar velocidad de internet', 'Crear copias de archivos'], correct: 1 },
                { category: 'Hipervisor', text: 'Un hipervisor de Tipo 1 se ejecuta...', options: ['Dentro de Windows/Linux', 'Solo en la nube', 'Directamente sobre el hardware', 'Únicamente en VMs'], correct: 2 },
                { category: 'IA 101', text: 'Una IA para una tarea específica es:', options: ['IA General (AGI)', 'Superinteligencia (ASI)', 'IA Débil o Estrecha (ANI)', 'IA Cognitiva'], correct: 2 },
                { category: 'Machine Learning', text: '¿Qué caracteriza al Machine Learning?', options: ['Sigue reglas fijas', 'Aprende de los datos', 'Solo funciona con imágenes', 'Requiere intervención humana'], correct: 1 },
                { category: 'Hipervisor', text: '¿Cuál es un ejemplo de hipervisor de Tipo 2?', options: ['VMware ESXi', 'Hyper-V Server', 'Oracle VirtualBox', 'KVM'], correct: 2 }
            ];

            function switchScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens[screenName].classList.add('active');
            }

            async function createGame() {
                createGameBtn.disabled = true;
                gameCode = Math.random().toString(36).substring(2, 7).toUpperCase();
                lobbyGameCodeEl.textContent = gameCode;
                
                await db.collection('games').doc(gameCode).set({
                    state: 'lobby',
                    currentQuestion: -1,
                    players: {},
                    questions: questions
                });

                switchScreen('lobby');
                listenForPlayers();
            }

            function listenForPlayers() {
                playersUnsubscribe = db.collection('games').doc(gameCode).onSnapshot(doc => {
                    const gameData = doc.data();
                    if (!gameData) return;
                    const players = gameData.players ? Object.keys(gameData.players) : [];
                    totalPlayers = players.length;
                    playerLobbyList.innerHTML = players.map(name => `<li>${name}</li>`).join('');
                    startGameBtn.disabled = players.length === 0;
                });
            }

            async function startGame() {
                if (playersUnsubscribe) playersUnsubscribe();
                currentQuestionIndex = 0;
                await launchQuestion();
            }

            async function launchQuestion() {
                nextQuestionBtn.style.display = 'none';
                resultsChart.innerHTML = '';
                await db.collection('games').doc(gameCode).update({
                    state: 'question',
                    currentQuestion: currentQuestionIndex
                });
                
                const question = questions[currentQuestionIndex];
                questionTextProf.textContent = `(${question.category}) ${question.text}`;
                totalPlayersEl.textContent = totalPlayers;
                responseCountEl.textContent = 0;
                
                switchScreen('game');
                listenForResponses();
            }

            function listenForResponses() {
                const questionResponsesRef = db.collection('games').doc(gameCode).collection('responses').doc(`q${currentQuestionIndex}`);
                responsesUnsubscribe = questionResponsesRef.onSnapshot(doc => {
                    if (!doc.exists) return;
                    const responses = doc.data();
                    const responseCount = Object.keys(responses).length;
                    responseCountEl.textContent = responseCount;
                    if (responseCount === totalPlayers) {
                        showResults();
                    }
                });
            }

            async function showResults() {
                if (responsesUnsubscribe) responsesUnsubscribe();

                const question = questions[currentQuestionIndex];
                const responsesRef = db.collection('games').doc(gameCode).collection('responses').doc(`q${currentQuestionIndex}`);
                const responsesDoc = await responsesRef.get();
                const responsesData = responsesDoc.data();

                const gameRef = db.collection('games').doc(gameCode);
                const gameDoc = await gameRef.get();
                const gameData = gameDoc.data();
                
                let playerUpdates = {};
                if (responsesData) {
                    for (const playerName in responsesData) {
                        const currentScore = gameData.players[playerName] || 0;
                        if (responsesData[playerName] === question.correct) {
                            playerUpdates[`players.${playerName}`] = currentScore + 10;
                        }
                    }
                }
                if (Object.keys(playerUpdates).length > 0) {
                    await gameRef.update(playerUpdates);
                }

                const voteCounts = question.options.map(() => 0);
                if (responsesData) {
                    for (const playerName in responsesData) {
                        if (voteCounts[responsesData[playerName]] !== undefined) {
                            voteCounts[responsesData[playerName]]++;
                        }
                    }
                }

                resultsChart.innerHTML = '';
                question.options.forEach((option, index) => {
                    const percentage = totalPlayers > 0 ? (voteCounts[index] / totalPlayers) * 100 : 0;
                    const isCorrect = index === question.correct;
                    const bar = document.createElement('div');
                    bar.className = 'bar-container';
                    bar.innerHTML = `
                        <div class="bar-label">${option}</div>
                        <div class="bar ${isCorrect ? 'correct' : ''}" style="width: ${percentage}%;">
                            ${voteCounts[index]}
                        </div>
                    `;
                    resultsChart.appendChild(bar);
                });

                if (currentQuestionIndex < questions.length - 1) {
                    nextQuestionBtn.style.display = 'block';
                } else {
                    await db.collection('games').doc(gameCode).update({ state: 'finished' });
                    showRankingBtn.style.display = 'block';
                }
            }
            
            async function nextQuestion() {
                currentQuestionIndex++;
                await launchQuestion();
            }
            
            async function showFinalRanking() {
                const gameDoc = await db.collection('games').doc(gameCode).get();
                const playersData = gameDoc.data().players;
                const sortedPlayers = Object.entries(playersData).sort((a, b) => b[1] - a[1]);
                
                scoreboard.innerHTML = sortedPlayers.map(([name, score], index) => `<li>${index + 1}. ${name}: ${score} pts</li>`).join('');
                switchScreen('ranking');
            }

            switchScreen('init');
            createGameBtn.addEventListener('click', createGame);
            startGameBtn.addEventListener('click', startGame);
            nextQuestionBtn.addEventListener('click', nextQuestion);
            showRankingBtn.addEventListener('click', showFinalRanking);
        }

        // =====================================================================
        // ====================== CÓDIGO DEL ESTUDIANTE ========================
        // =====================================================================
        function initEstudiante() {
            const screens = { join: document.getElementById('join-screen-stud'), waiting: document.getElementById('waiting-screen-stud'), question: document.getElementById('question-screen-stud'), answerSent: document.getElementById('answer-sent-screen-stud'), end: document.getElementById('end-screen-stud') };
            const playerNameInput = document.getElementById('player-name');
            const gameCodeInput = document.getElementById('game-code-input');
            const joinBtn = document.getElementById('join-btn');
            const optionsContainer = document.getElementById('options-container');

            let gameCode = null, playerName = null, gameUnsubscribe = null;

            function switchScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens[screenName].classList.add('active');
            }

            async function joinGame() {
                playerName = playerNameInput.value.trim();
                gameCode = gameCodeInput.value.trim().toUpperCase();

                if (!playerName || !gameCode) {
                    alert('Por favor, ingresa tu nombre y el código de la sala.');
                    return;
                }

                joinBtn.disabled = true;
                joinBtn.textContent = 'Conectando...';

                try {
                    const gameRef = db.collection('games').doc(gameCode);
                    const gameDoc = await gameRef.get();

                    if (!gameDoc.exists) {
                        alert('La sala no existe. Verifica el código.');
                        joinBtn.disabled = false;
                        joinBtn.textContent = 'Unirse';
                        return;
                    }
                    
                    await gameRef.update({
                        [`players.${playerName}`]: 0
                    });

                    listenToGameChanges();
                    switchScreen('waiting');

                } catch (error) {
                    console.error("Error al unirse a la sala:", error);
                    alert("Hubo un error al conectar. Revisa la consola o intenta de nuevo.");
                    joinBtn.disabled = false;
                    joinBtn.textContent = 'Unirse';
                }
            }

            function listenToGameChanges() {
                const gameRef = db.collection('games').doc(gameCode);
                gameUnsubscribe = gameRef.onSnapshot((doc) => {
                    if (!doc.exists) {
                        if (gameUnsubscribe) gameUnsubscribe();
                        alert("La sala de juego ha sido cerrada.");
                        location.reload();
                        return;
                    }
                    const gameData = doc.data();

                    if (gameData.state === 'question') {
                        const responseRef = db.collection('games').doc(gameCode).collection('responses').doc(`q${gameData.currentQuestion}`);
                        responseRef.get().then(responseDoc => {
                            if (responseDoc.exists && responseDoc.data()[playerName] !== undefined) {
                                switchScreen('answerSent');
                            } else {
                                const question = gameData.questions[gameData.currentQuestion];
                                displayQuestion(question);
                            }
                        });
                    } else if (gameData.state === 'finished') {
                        if (gameUnsubscribe) gameUnsubscribe();
                        switchScreen('end');
                    } else if (gameData.state === 'lobby') {
                        switchScreen('waiting');
                    }
                }, (error) => {
                    console.error("Error de conexión con la sala:", error);
                    if (gameUnsubscribe) gameUnsubscribe();
                    alert("Se perdió la conexión con la sala.");
                    location.reload();
                });
            }
            
            function displayQuestion(question) {
                optionsContainer.innerHTML = '';
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = option;
                    button.onclick = () => sendAnswer(index);
                    optionsContainer.appendChild(button);
                });
                switchScreen('question');
            }
            
            async function sendAnswer(answerIndex) {
                optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);

                const gameData = (await db.collection('games').doc(gameCode).get()).data();
                const questionIndex = gameData.currentQuestion;
                
                const responseRef = db.collection('games').doc(gameCode).collection('responses').doc(`q${questionIndex}`);
                
                await responseRef.set({
                    [playerName]: answerIndex
                }, { merge: true });

                switchScreen('answerSent');
            }

            switchScreen('join');
            joinBtn.addEventListener('click', joinGame);
        }
    </script>
</body>
</html>